{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "appServiceName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Azure Web App to deploy WordPress to."
      }
    },
    "mysqlServerName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Azure Database for MariaDB server to use for WordPress."
      }
    },
    "mysqlUsername": {
      "type": "string",
      "metadata": {
        "description": "The username to use when connecting to the Azure Database for MariaDB server."
      }
    },
    "mysqlPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password to use when connecting to the Azure Database for MariaDB server."
      }
    },
    "mysqlDatabaseName": {
      "type": "string",
      "metadata": {
        "description": "The name of the database to use for WordPress."
      }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Azure Storage account to use for media files."
      }
    }
  },
  "variables": {
    "wpConfig": "[concat('# Generated by Azure App Service deployment, at ', utcNow(), '.\n\n',
      'define(\'DB_NAME\', \'', parameters('mysqlDatabaseName'), '\');\n',
      'define(\'DB_USER\', \'', parameters('mysqlUsername'), '\');\n',
      'define(\'DB_PASSWORD\', \'', parameters('mysqlPassword'), '\');\n',
      'define(\'DB_HOST\', \'', reference(variables('mysqlServerResourceId')).fullyQualifiedDomainName, '\');\n',
      'define(\'DB_CHARSET\', \'utf8\');\n',
      'define(\'DB_COLLATE\', \'\');\n',
      '$table_prefix  = \'wp_\';\n',
      'define(\'WP_DEBUG\', false);\n',
      'if ( !defined(\'ABSPATH\') ) {\n',
      '  define(\'ABSPATH\', dirname(__FILE__) . \'/\');\n',
      '}\n',
      'require_once(ABSPATH . \'wp-settings.php\');\n')]"
  },
  "resources": [
    {
      "type": "Microsoft.Web/sites/config",
      "apiVersion": "2018-11-01",
      "name": "[concat(parameters('appServiceName'), '/WordPress')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Web/sites/', parameters('appServiceName'))]",
        "[concat('Microsoft.DBforMariaDB/servers/', parameters('mysqlServerName'))]",
        "[concat('Microsoft.Storage/storageAccounts/', parameters('storageAccountName'))]"
      ],
      "properties": {
        "PHP": {
          "version": "7.4",
          "extensions": [
            {
              "name": "imagick",
              "publisher": "PECL"
            }
          ]
        },
        "appSettings": [
          {
            "name": "WEBSITE_TIME_ZONE",
            "value": "Central Europe Standard Time"
          },
          {
            "name": "WORDPRESS_DB_HOST",
            "value": "[reference(variables('mysqlServerResourceId')).fullyQualifiedDomainName]"
          },
          {
            "name": "WORDPRESS_DB_NAME",
            "value": "[parameters('mysqlDatabaseName')]"
          },
          {
            "name": "WORDPRESS_DB_USER",
            "value": "[parameters('mysqlUsername')]"
          },
          {
            "name": "WORDPRESS_DB_PASSWORD",
            "value": "[parameters('mysqlPassword')]"
          },
          {
            "name": "WORDPRESS_AUTH_KEY",
            "value": "[concat('auto-', uniqueString(resourceGroup().id))]"
          },
          {
            "name": "WORDPRESS_SECURE_AUTH_KEY",
            "value": "[concat('auto-', uniqueString(resourceGroup().id))]"
          },
          {
            "name": "WORDPRESS_LOGGED_IN_KEY",
            "value": "[concat('auto-', uniqueString(resourceGroup().id))]"
          },
          {
            "name": "WORDPRESS_NONCE_KEY",
            "value": "[concat('auto-', uniqueString(resourceGroup().id))]"
          },
          {
            "name": "WORDPRESS_AUTH_SALT",
            "value": "[concat('auto-', uniqueString(resourceGroup().id))]"
          },
          {
            "name": "WORDPRESS_SECURE_AUTH_SALT",
            "value": "[concat('auto-', uniqueString(resourceGroup().id))]"
          },
          {
            "name": "WORDPRESS_LOGGED_IN_SALT",
            "value": "[concat('auto-', uniqueString(resourceGroup().id))]"
          },
          {
            "name": "WORDPRESS_NONCE_SALT",
            "value": "[concat('auto-', uniqueString(resourceGroup().id))]"
          },
          {
            "name": "AZURE_STORAGE_ACCOUNT",
            "value": "[parameters('storageAccountName')]"
          },
          {
            "name": "AZURE_STORAGE_ACCESS_KEY",
            "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2019-06-01').keys[0].value]"
          },
          {
            "name": "WORDPRESS_CONFIG_EXTRA",
            "value": "[variables('wpConfig')]"
          }
        ]
      }
    }
  ],
  "outputs": {
    "siteUrl": {
      "type": "string",
      "value": "[concat('https://', parameters('appServiceName'), '.azurewebsites.net')]"
    },
    "mysqlServerResourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.DBforMariaDB/servers', parameters('mysqlServerName'))]"
    },
    "storageAccountResourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
    }
  }
}